name: Raindrop Sync

on:
  schedule:
    - cron: '*/5 * * * *'  # 每 5 分钟执行一次
  workflow_dispatch:      # 允许手动触发

jobs:
  sync_and_push:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. 检出当前仓库（包含脚本）
      - name: Checkout Scripts Repo
        uses: actions/checkout@v4
        with:
          path: scripts_repo

      # 2. 检出 Gitee 私有仓库（存放笔记）
      - name: Checkout Gitee Repo
        run: |
          # 使用 oauth2 作为鉴权用户名
          git clone https://oauth2:${{ secrets.GITEE_TOKEN }}@gitee.com/${{ secrets.GITEE_USER }}/${{ secrets.GITEE_REPO }}.git gitee_workspace

      # 3. 设置 Python 环境 (使用 uv)
      - name: Install uv
        uses: astral-sh/setup-uv@v5

      # 4. 运行同步脚本
      - name: Run Sync Script
        env:
          RAINDROP_API_TOKEN: ${{ secrets.RAINDROP_API_TOKEN }}
          OUTPUT_DIR: ${{ github.workspace }}/gitee_workspace/30_Resources
          SYNC_DAYS: 3 # 频繁同步，只需要检查最近几天的即可
        run: |
          cd scripts_repo
          uv run raindrop_api_sync.py

      # 5. 提交并推送到 Gitee (第一次：原始数据)
      - name: Push Raw Data
        working-directory: gitee_workspace
        run: |
          # 配置 Git 用户信息
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # 检查是否有变更
          git add .
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            # 提交更改
            timestamp=$(date "+%Y-%m-%d %H:%M:%S")
            git commit -m "sync: Raindrop bookmarks $timestamp"
            
            # 推送回 Gitee
            git push origin HEAD:main
          fi

      # 6. 运行 AI 总结 (独立步骤)
      - name: Run AI Summarizer
        env:
          DEDAO_API_TOKEN: ${{ secrets.DEDAO_API_TOKEN }}
          OUTPUT_DIR: ${{ github.workspace }}/gitee_workspace/30_Resources
        run: |
          cd scripts_repo
          uv run ai_summarizer.py
          
      # 7. 提交并推送到 Gitee (第二次：AI 总结)
      - name: Push AI Data
        working-directory: gitee_workspace
        if: success()
        run: |
          git add .
          if git diff --staged --quiet; then
            echo "No AI summaries generated"
            exit 0
          fi
          
          git commit -m "feat: add AI summaries"
          git push origin HEAD:main
